import sys
import pefile
import argparse
import re
import binascii

# Dumps the second payload form the image file by searching for the keyword and decrypting content after keyword

def main(arguments):
	
	parser = argparse.ArgumentParser(description=__doc__, formatter_class=argparse.RawDescriptionHelpFormatter)
	parser.add_argument('file', help="file", type=str)
	args = parser.parse_args(arguments)


	keyword = b'\x72\x65\x64\x61\x6F\x6C\x75\x72\x63'
	key = 0x61
	file = open(args.file , "rb")
	data = file.read()
	pattern = re.search(keyword,data)
	offset = hex(pattern.start())
	print("Offset in file: " + offset)
	
	file.seek(int(offset,16)+9,0)
	decrypted_payload = bytearray()
	
	while(byte := file.read(1)):
		decrypted_payload+=(byte[0] ^ key).to_bytes(1, 'little')
	
	file.close()
	
	#print(decrypted_payload)

	print("Writing payload to payload2.bin")
	try:
		f = open("payload2.bin", "wb")
		f.write(decrypted_payload)
		f.close()
	except Exception as error:
		print("Couldnt write to file ", error)

if __name__ == '__main__':
    main(sys.argv[1:])

